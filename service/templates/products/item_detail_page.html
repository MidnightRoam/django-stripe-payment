{% extends 'base.html' %}
{% load static %}
{% block title %} {{ title }} {% endblock %}
{% block content %}
<div class="product-detail__wrapper">
        <div class="product-detail__page">
            <section class="product__section">
            <div class="product__head">
                <div class="product__poster" style="background-image: url('{{ item.poster.url }}')"></div>
                <div class="product__info">
                    <p class="product__title">{{ item.name }}</p>
                    <div class="product__rating">
                      <p class="rating">
                          <img src="https://cdn-icons-png.flaticon.com/512/1828/1828961.png" alt="product-rating">
                          {% if product_rating.rate__avg %}
                            {{ product_rating.rate__avg|floatformat }}
                          {% else %}
                            No one has rated yet
                          {% endif %}
                      </p>
                      <a href="{% url 'reviews' item.slug %}" class="rating__link">Rate</a>
                    </div>
                    <ul class="product__amount">
                       <li class="value">{{ item.get_product_in_stock }}</li>
                    </ul>
                    <div class="product__price">
                        <form action="{% url 'item_detail' item.pk %}" method="POST" class="to-cart__form">
                         {% csrf_token %}
                        <input
                                class="btn-primary cart {% if item.amount < 1 %}disable{% endif %}"
                                {% if not item.amount %} disabled {% endif %}
                                type="submit" value=" "
                        >
                        </form>
                        <button
                                type="submit"
                                id="checkout-button"
                                class="btn-primary {% if item.amount < 1 %}disable{% endif %}"
                                {% if not item.amount %} disabled {% endif %}
                        >
                            BUY</button>
                    {% if item.discounts.exists %}
                          <div class="product__discount">
                              <p class="discount">{{ item.get_discounted_price }}</p>
                          </div>
                          <p class="old__price">{{ item.get_price }}</p>
                          <p class="discount__percent">-{{ item.get_percent_discount }}</p>
                      {% else %}
                          <div class="product__discount">
                              <p class="regular-price">{{ item.get_price }}</p>
                          </div>
                    {% endif%}

                    </div>
                    <div class="product__regions">
                        <div class="languages">
                            <div class="select" id="languages">
                                <p class="title">Languages</p>
                                <p class="caret" id="caret"></p>
                            </div>
                            <div class="dropdown" id="languages-dropdown">
                                {% for language in item.languages.all %}
                                <p class="language">{{ language }}</p>
                                <p class="language__option">{{ language.get_language_option }}</p>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="regions">
                            <p class="title">Region of activation</p>
                            {% for activation in item.regions.all %}
                            <p class="region">{{ activation.region }}</p>
                            {% endfor %}
                        </div>
                        <div class="activation">
                            <p class="title">Platform</p>
                            {% for platform in item.platform.all %}
                            <a href="{% url 'index' platform.slug %}" class="platform">{{ platform }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="product__likes">
                <form action="{% url 'add_to_favorites' item.pk %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="item_id" value="{{ item.id }}">
                <input type="image" id="favorite-img" class="favorite__img" src="https://cdn-icons-png.flaticon.com/512/535/535285.png" />
                </form>
                <p class="added_to_favorites">{{ added_to_favorites }} &#x2764;</p>
            </div>
            </section>
            <section class="product__sub-info">
            <div class="info">
                <div class="genres">
                    <p class="name">Genre</p>
                    <p class="genre">. . .</p>
                </div>
                <div class="platforms">
                    <p class="name">Platforms</p>
                    <p class="platform">
                    {% for platform in item.platform.all %}
                        {{ platform }}
                     {% endfor %}
                    </p>
                </div>
                <div class="release">
                    <p class="name">Release date</p>
                    <p class="date">25.05.2022</p>
                </div>
                <div class="publishers">
                    <p class="name">Publisher</p>
                    {% for publisher in item.publisher.all %}
                    <a href="{% url 'publisher' publisher.slug %}" class="publisher">{{ publisher }}</a>
                    {% endfor %}
                </div>
                <div class="developers">
                    <p class="name">Developer</p>
                    {% for developer in item.developer.all %}
                    <a href="{% url 'developer' developer.slug %}" class="developer">{{ developer }}</a>
                    {% endfor %}
                </div>
                <div class="item__tags">
                  {% for tag in item.tags.all %}
                  <p class="product__tag">{{ tag }}</p>
                  {% endfor %}
                </div>
            </div>
            <div class="media__content">
                <div class="head">
                    <div class="switchers">
                        <p class="title active__bar" id="screenshots-bar">SCREENSHOTS</p>
                        <p class="title" id="trailer-bar">TRAILER</p>
                    </div>
                    <div class="slider__controls">
                        <p id="left" class="fa fa-arrow-left control"></p>
                        <p id="right" class="fa fa-arrow-right control"></p>
                    </div>
                </div>
                <div class="screenshots active" id="screenshots">
                    {% for screenshot in item.screenshots.all %}
                        <div class="popup">
                            <p class="cross hide" id="screenshot-close">&#10006;</p>
                            <img src="{{ screenshot.image.url }}"
                                 alt="{{ screenshot.item.name }}"
                                 class="screenshot"
                            >
                        </div>
                    {% endfor %}
                </div>
                <div class="trailers" id="trailer-popup">
                    {% for trailer in item.trailers.all %}
                    <div class="popup">
                        <iframe src="{{ trailer.url }}" class="game__trailer"></iframe>
                    </div>
                    {% endfor %}
                </div>
            </div>
            </section>
            <section class="product__about">
                <div class="tech__requirements">
                    <div class="minimum">
                        {% for minimal in item.minimal_system_requirements.all %}
                        <div class="title">Minimal system requirements</div>
                        <div class="os">
                            <p class="name">OC</p>
                            <p class="value">{{ minimal.os }}</p>
                        </div>
                        <div class="processor">
                            <p class="name">Processor</p>
                            <p class="value">{{ minimal.processor }}</p>
                        </div>
                        <div class="ram">
                            <p class="name">RAM</p>
                            <p class="value">{{ minimal.ram }} GB RAM</p>
                        </div>
                        <div class="graphics__card">
                            <p class="name">Graphics Card</p>
                            <p class="value">{{ minimal.graphics_card }}</p>
                        </div>
                        <div class="direct-x">
                            <p class="name">DirectX</p>
                            <p class="value">{{ minimal.directx }}</p>
                        </div>
                        <div class="disk__space">
                            <p class="name">Disk Space</p>
                            <p class="value">{{ minimal.disk_space }} GB</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="description">
                    <h1 class="title">{{ item.get_tagline }}</h1>
                    <p class="text">{{ item.description }}</p>
                </div>
            </section>
        </div>
    </div>
    {% csrf_token %}
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
        var checkoutButton = document.getElementById("checkout-button");
        checkoutButton.addEventListener("click", function () {
          fetch("{% url 'buy' item.id %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': csrftoken
            }
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (session) {
              return stripe.redirectToCheckout({ sessionId: session.id });
            })
            .then(function (result) {
              if (result.error) {
                alert(result.error.message);
              }
            })
            .catch(function (error) {
              console.error("Payment error:", error);
            });
        });
    </script>
    <script src="{% static 'js/ui-components.js' %}"></script>
{% endblock %}